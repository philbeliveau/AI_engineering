# =============================================================================
# Knowledge Pipeline Streamlit Dockerfile
# =============================================================================
# Multi-stage build for Streamlit web ingestion interface
#
# Environment Variables (required at runtime):
#   MONGODB_URI    - MongoDB connection string (e.g., mongodb+srv://...)
#   QDRANT_URL     - Qdrant server URL (e.g., https://xxx.cloud.qdrant.io:6333)
#   QDRANT_API_KEY - Qdrant Cloud API key
#
# Optional Environment Variables:
#   PORT           - Server port (default: 8501, Railway sets dynamically)
#   PROJECT_ID     - Multi-tenant project isolation (default: ai_engineering)
#   ANTHROPIC_API_KEY - Required for extraction during ingestion
#
# Build: docker build -f Dockerfile.streamlit -t knowledge-streamlit .
# Run:   docker run -p 8501:8501 -e MONGODB_URI=... -e QDRANT_URL=... knowledge-streamlit
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Builder - Install uv and dependencies
# -----------------------------------------------------------------------------
FROM python:3.11-slim AS builder

# Install uv (fast Python package manager)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Set working directory
WORKDIR /app

# Copy dependency files first (cache optimization)
COPY pyproject.toml uv.lock README.md ./

# Install dependencies (torch uses CPU-only index via pyproject.toml)
RUN uv sync --frozen --no-dev --no-cache --no-install-project

# Fix Docling OpenCV conflict for headless Docker environments
# opencv-python requires libGL.so.1 which isn't in slim images
# opencv-python-headless provides identical API without system GL dependencies
# Use uv pip (uv manages packages, not pip directly)
RUN uv pip uninstall opencv-python 2>/dev/null || true && \
    uv pip install --no-cache opencv-python-headless && \
    echo "=== OpenCV Installation Verification ===" && \
    uv pip list | grep -i opencv

# -----------------------------------------------------------------------------
# Stage 2: Runtime - Minimal production image
# -----------------------------------------------------------------------------
FROM python:3.11-slim AS runtime

# Set environment variables
# - PYTHONDONTWRITEBYTECODE: Prevent .pyc files (smaller image)
# - PYTHONUNBUFFERED: Ensure logs are immediately flushed
# - PYTHONFAULTHANDLER: Enable faulthandler for debugging crashes
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONFAULTHANDLER=1

# Default environment variables for Railway compatibility
# PORT can be overridden at runtime (Railway sets this dynamically)
ENV PORT=8501 \
    PROJECT_ID=ai_engineering

# Streamlit configuration
ENV STREAMLIT_SERVER_PORT=${PORT} \
    STREAMLIT_SERVER_ADDRESS=0.0.0.0 \
    STREAMLIT_SERVER_HEADLESS=true \
    STREAMLIT_BROWSER_GATHER_USAGE_STATS=false

# Set working directory
WORKDIR /app

# Install uv in runtime (needed for subprocess calls to ingest.py)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy virtualenv from builder (contains all dependencies)
COPY --from=builder /app/.venv /app/.venv

# Copy application source code and scripts
COPY src/ /app/src/
COPY scripts/ /app/scripts/
COPY web_app.py /app/
COPY pyproject.toml uv.lock README.md /app/

# Add virtualenv to PATH
ENV PATH="/app/.venv/bin:$PATH"

# Expose default port (Railway will set PORT dynamically)
EXPOSE 8501

# Health check for container orchestration
# Streamlit serves on /healthz when running
HEALTHCHECK --interval=30s --timeout=10s --retries=3 --start-period=40s \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:${PORT}/_stcore/health', timeout=5)" || exit 1

# Run Streamlit with dynamic port binding
# Note: PORT is read from environment variable at runtime
CMD ["sh", "-c", "streamlit run web_app.py --server.port ${PORT} --server.address 0.0.0.0"]
